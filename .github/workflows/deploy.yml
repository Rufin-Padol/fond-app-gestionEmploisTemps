name: Deploy Angular App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.17.0'
        cache: 'npm'

    - name: Verify Node and npm versions
      run: |
        echo "Node version: $(node --version)"
        echo "npm version: $(npm --version)"

    - name: Install dependencies
      run: npm ci

    - name: Verify Angular CLI version
      run: |
        npx ng version
        echo "Angular project structure:"
        ls -la src/

    - name: Build application
      run: npm run build

    - name: Verify build output
      run: |
        echo "Build output:"
        ls -la dist/
        echo "Build size:"
        du -sh dist/

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: angular-build
        path: dist/
        retention-days: 1

  deploy:
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: angular-build
        path: dist/

    - name: Verify downloaded artifacts
      run: |
        echo "Downloaded build files:"
        ls -la dist/
        find dist/ -name "*.js" -o -name "*.css" -o -name "*.html" | head -10

    - name: Transfer files to VPS via SCP
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "dist/emplois-temps-fond/*"
        target: "/tmp/angular-build/"
        strip_components: 2

    - name: Transfer Docker files to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "Dockerfile,nginx.conf,docker-compose.yml"
        target: "/home/deploy/angular-app/"

    - name: Deploy on VPS
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          
          echo "ğŸš€ DÃ©marrage du dÃ©ploiement Angular..."
          
          # CrÃ©er les rÃ©pertoires nÃ©cessaires
          mkdir -p /home/deploy/angular-app
          mkdir -p /tmp/angular-build
          
          # Naviguer vers le rÃ©pertoire de dÃ©ploiement
          cd /home/deploy/angular-app
          
          # VÃ©rifier les fichiers transfÃ©rÃ©s
          echo "ğŸ“ Fichiers Docker disponibles:"
          ls -la
          
          echo "ğŸ“ Build Angular disponible:"
          ls -la /tmp/angular-build/
          
          # ArrÃªter et supprimer l'ancien container
          echo "ğŸ“¦ ArrÃªt de l'ancien container..."
          docker stop angular-app 2>/dev/null || echo "Aucun container Ã  arrÃªter"
          docker rm angular-app 2>/dev/null || echo "Aucun container Ã  supprimer"
          
          # Nettoyer les anciennes images
          echo "ğŸ§¹ Nettoyage des anciennes images..."
          docker image prune -f
          
          # CrÃ©er un Dockerfile temporaire qui copie les fichiers prÃ©-buildÃ©s
          cat > Dockerfile.deploy << 'EOF'
          FROM nginx:alpine
          
          # Supprimer la configuration nginx par dÃ©faut
          RUN rm /etc/nginx/conf.d/default.conf
          
          # Copier la configuration nginx personnalisÃ©e
          COPY nginx.conf /etc/nginx/conf.d/
          
          # Copier les fichiers buildÃ©s depuis le rÃ©pertoire temporaire
          COPY /tmp/angular-build/ /usr/share/nginx/html/
          
          # Exposer le port 80
          EXPOSE 80
          
          # DÃ©marrer nginx
          CMD ["nginx", "-g", "daemon off;"]
          EOF
          
          # CrÃ©er une image temporaire avec les fichiers buildÃ©s
          docker create --name build-files alpine
          docker cp /tmp/angular-build/. build-files:/tmp/angular-build/
          
          # Build de la nouvelle image
          echo "ğŸ”¨ Build de la nouvelle image..."
          docker build -f Dockerfile.deploy -t angular-app:latest .
          
          # Nettoyer l'image temporaire
          docker rm build-files 2>/dev/null || true
          
          # DÃ©marrer le nouveau container
          echo "ğŸ¯ DÃ©marrage du nouveau container..."
          docker run -d \
            --name angular-app \
            -p 3000:80 \
            --restart unless-stopped \
            angular-app:latest
          
          # VÃ©rifier que le container fonctionne
          sleep 5
          if docker ps | grep -q angular-app; then
            echo "âœ… DÃ©ploiement rÃ©ussi! Application disponible sur le port 3000"
            echo "ğŸ“‹ Status du container:"
            docker ps | grep angular-app
            echo "ğŸ“‹ Logs rÃ©cents:"
            docker logs angular-app --tail 10
          else
            echo "âŒ Erreur lors du dÃ©ploiement"
            docker logs angular-app --tail 20
            exit 1
          fi
          
          # Nettoyer les fichiers temporaires
          rm -rf /tmp/angular-build/*
          rm -f Dockerfile.deploy