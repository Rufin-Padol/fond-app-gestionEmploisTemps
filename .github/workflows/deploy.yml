name: Deploy Angular App

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22.17.0'
        cache: 'npm'

    - name: Verify Node and npm versions
      run: |
        echo "Node version: $(node --version)"
        echo "npm version: $(npm --version)"

    - name: Debug SSH Configuration
      run: |
        echo "=== Debug SSH Configuration ==="
        echo "Host: ${{ secrets.VPS_HOST }}"
        echo "Username: ${{ secrets.VPS_USERNAME }}"
        echo "Key contents (first 50 chars):"
        echo "${{ secrets.VPS_SSH_KEY }}" | head -c 50
        echo "..."
        echo "Key ends with:"
        echo "${{ secrets.VPS_SSH_KEY }}" | tail -c 50
        
        mkdir -p ~/.ssh
        echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        echo "SSH key file created with permissions:"
        ls -la ~/.ssh/deploy_key
        
        echo "Testing SSH connection (verbose mode):"
        ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            -v \
            ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} \
            "echo 'SSH connection successful'" || echo "SSH connection failed"

    - name: Transfer entire project to VPS
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        source: "."
        target: "/home/mbemnova1/deploy/angular-app/"
        strip_components: 0
        debug: true

    - name: Deploy on VPS (Build and Run)
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.VPS_HOST }}
        username: ${{ secrets.VPS_USERNAME }}
        key: ${{ secrets.VPS_SSH_KEY }}
        script: |
          set -e
          
          echo "ğŸš€ DÃ©marrage du dÃ©ploiement Angular..."
          
          # Naviguer vers le rÃ©pertoire de dÃ©ploiement
          cd /home/mbemnova1/deploy/angular-app
          
          # Installer les dÃ©pendances
          echo "ğŸ“¦ Installation des dÃ©pendances..."
          npm ci
          
          # Build de l'application
          echo "ğŸ”¨ Construction de l'application..."
          npm run build
          
          # VÃ©rifier que le build a rÃ©ussi
          if [ ! -d "dist" ]; then
            echo "âŒ Erreur: le dossier dist/ n'a pas Ã©tÃ© crÃ©Ã©"
            exit 1
          fi
          
          # ArrÃªter et supprimer l'ancien container
          echo "ğŸ“¦ ArrÃªt de l'ancien container..."
          docker stop angular-app 2>/dev/null || echo "Aucun container Ã  arrÃªter"
          docker rm angular-app 2>/dev/null || echo "Aucun container Ã  supprimer"
          
          # Nettoyer les anciennes images
          echo "ğŸ§¹ Nettoyage des anciennes images..."
          docker image prune -f
          
          # CrÃ©er un Dockerfile temporaire
          echo "FROM nginx:alpine" > Dockerfile.deploy
          echo "RUN rm /etc/nginx/conf.d/default.conf" >> Dockerfile.deploy
          echo "COPY nginx.conf /etc/nginx/conf.d/" >> Dockerfile.deploy
          echo "COPY dist/ /usr/share/nginx/html/" >> Dockerfile.deploy
          echo "EXPOSE 80" >> Dockerfile.deploy
          echo 'CMD ["nginx", "-g", "daemon off;"]' >> Dockerfile.deploy
          
          # Build de la nouvelle image
          echo "ğŸ”¨ Build de la nouvelle image Docker..."
          docker build -f Dockerfile.deploy -t angular-app:latest .
          
          # DÃ©marrer le nouveau container
          echo "ğŸ¯ DÃ©marrage du nouveau container..."
          docker run -d \
            --name angular-app \
            -p 3000:80 \
            --restart unless-stopped \
            angular-app:latest
          
          # VÃ©rifier que le container fonctionne
          sleep 5
          if docker ps | grep -q angular-app; then
            echo "âœ… DÃ©ploiement rÃ©ussi! Application disponible sur le port 3000"
            echo "ğŸ“‹ Status du container:"
            docker ps | grep angular-app
            echo "ğŸ“‹ Logs rÃ©cents:"
            docker logs angular-app --tail 10
          else
            echo "âŒ Erreur lors du dÃ©ploiement"
            docker logs angular-app --tail 20
            exit 1
          fi
          
          # Nettoyer les fichiers temporaires
          rm -f Dockerfile.deploy